package models.vulnerability.graphql.mutations.vulnerability;

import models.graphql.mutation.GraphQLMutations;
import models.vulnerability.Vulnerability;
import models.vulnerability.graphql.mutations.CreateVulnerabilityQL;
import utilities.Util;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.Locale;

public class CreateWebVulnerabilityQL extends CreateVulnerabilityQL {

    public CreateWebVulnerabilityQL(Vulnerability vulnerability) {
        super(vulnerability);
    }

    @Override
    protected void prepareQuery() {
        StringBuilder input = new StringBuilder();
        input.append("projectId: ").append(this.vulnerability.getProjectId());
        input.append(", assetId: ").append(this.vulnerability.getAssetId());
        input.append(", title: \"").append(Util.jsonSafeString(this.vulnerability.getTitle())).append("\"");
        input.append(", description: \"").append(Util.jsonSafeString(this.vulnerability.getDescription())).append("\"");
        input.append(", solution: \"").append(Util.jsonSafeString(this.vulnerability.getSolution())).append("\"");
        if (this.vulnerability.getReference() != null && !this.vulnerability.getReference().isEmpty()) {
            input.append(", reference: \"").append(Util.jsonSafeString(this.vulnerability.getReference())).append("\"");
        }
        input.append(", impactLevel: ").append(normalizeLevel(this.vulnerability.getImpact()));
        input.append(", probabilityLevel: ").append(normalizeLevel(this.vulnerability.getProbability()));
        input.append(", severity: ").append(resolveSeverity());
        input.append(", summary: \"").append(Util.jsonSafeString(this.vulnerability.getSummary())).append("\"");
        input.append(", impactDescription: \"").append(Util.jsonSafeString(this.vulnerability.getImpactResume())).append("\"");
        input.append(", stepsToReproduce: \"").append(Util.jsonSafeString(this.vulnerability.getWebSteps())).append("\"");
        input.append(", request: \"").append(Util.jsonSafeString(this.vulnerability.getWebRequest())).append("\"");
        input.append(", response: \"").append(Util.jsonSafeString(this.vulnerability.getWebResponse())).append("\"");
        if (this.vulnerability.getInvaded() != null) {
            input.append(", compromisedEnvironment: ").append(this.vulnerability.getInvaded());
        }
        input.append(", method: ").append(normalizeMethod(this.vulnerability.getWebMethod()));
        input.append(", scheme: ").append(normalizeScheme(this.vulnerability.getWebProtocol()));
        input.append(", url: \"").append(Util.jsonSafeString(this.vulnerability.getWebUrl())).append("\"");
        input.append(", port: ").append(resolvePort());
        if (this.vulnerability.getWebParameters() != null && !this.vulnerability.getWebParameters().isEmpty()) {
            input.append(", parameters: \"").append(Util.jsonSafeString(this.vulnerability.getWebParameters())).append("\"");
        }

        this.query = GraphQLMutations.mutationCreateWebVulnerability.replace("%1$s", input.toString());
    }

    private String normalizeLevel(String value) {
        if (value == null || value.isEmpty()) {
            return "LOW";
        }
        return value.trim().toUpperCase(Locale.ROOT);
    }

    private String normalizeMethod(String value) {
        if (value == null || value.isEmpty()) {
            return "GET";
        }
        return value.trim().toUpperCase(Locale.ROOT);
    }

    private String normalizeScheme(String value) {
        if (value == null || value.isEmpty()) {
            return "UNKNOWN";
        }
        String normalized = value.trim().toUpperCase(Locale.ROOT);
        if (normalized.equals("HTTP") || normalized.equals("HTTPS") || normalized.equals("WS") || normalized.equals("WSS")) {
            return normalized;
        }
        return "UNKNOWN";
    }

    private String resolveSeverity() {
        if (this.vulnerability.isNotification()) {
            return "NOTIFICATION";
        }
        String impact = this.vulnerability.getImpact();
        if (impact == null || impact.isEmpty()) {
            return "LOW";
        }
        return impact.trim().toUpperCase(Locale.ROOT);
    }

    private int resolvePort() {
        Integer webPort = this.vulnerability.getWebPort();
        if (webPort != null && webPort > 0) {
            return webPort;
        }
        String url = this.vulnerability.getWebUrl();
        if (url != null && !url.isEmpty()) {
            try {
                URI uri = new URI(url);
                if (uri.getPort() > 0) {
                    return uri.getPort();
                }
                String scheme = uri.getScheme();
                if (scheme != null) {
                    if (scheme.equalsIgnoreCase("https") || scheme.equalsIgnoreCase("wss")) {
                        return 443;
                    }
                    if (scheme.equalsIgnoreCase("http") || scheme.equalsIgnoreCase("ws")) {
                        return 80;
                    }
                }
            } catch (URISyntaxException ignored) {
            }
        }
        String protocol = this.vulnerability.getWebProtocol();
        if (protocol != null && (protocol.equalsIgnoreCase("https") || protocol.equalsIgnoreCase("wss"))) {
            return 443;
        }
        return 80;
    }
}
